name: Build Wolfenstein 3D

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dosbox-x (apt)
      run: sudo apt-get install -y dosbox

    - name: Prepare Assets
      run: |
        mkdir -p build
        echo 'echo Preparing assets...' > build/assets.bat

    - name: Ensure Borland C++ Config
      run: |
        mkdir -p programs/borlandc
        echo '{ "PATH": "c:\\borlandc\\bin;c:\\tc\\bin" }' > programs/borlandc/config.json

    - name: Compile
      uses: joncloud/dos-build-action@main
      timeout-minutes: 2
      with:
        programs: |
          $/borlandc:c:\borlandc
          WOLFSRC:c:\WOLFSRC
          WOLF3D:c:\WOLF3D
        run: |
          c:
          cd \WOLFSRC
          bcc @wolf3d.prj > c:\build\build_log.txt
          c:\build\assets.bat
        conf: |
          [dosbox]
          memsize=256

          [cpu]
          cycles=max
          turbo=true

    - name: Prepare Results
      if: always()
      run: |
        echo "Build Log"
        cat build/build_log.txt

    - name: Zip the build output
      run: |
        zip -r wolf3d.zip WOLF3D

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-dos
        path: wolf3d.zip
